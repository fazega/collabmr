<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <head>

  </head>

  <body onload="work()">
    <h3 id="metaData"></h3>
    <h3>Data size : </h3>
    <div id="data"></div>
    <h3>Result </h3>
    <div id="result"></div>
  </body>

  <script type="text/javascript">
    var url = "http://localhost:8080"
    function map(data) {
      /* count the number of words in the body of document */
      var mapped = new Map();
      for(var word of data.split(" ")) {
        if(word == "Love") {
          if(!mapped.get(word)) {
              mapped.set(word, ["1"]);
          }
          else {
            mapped.get(word).push("1");
          }
        }
      }
      return JSON.stringify([...mapped]);
    }

    function reduce(data) {
      /* sum up all the word counts */
      var l = JSON.parse(data);
      var reduced = new Map();
      for(var entry of l) {
        reduced.set(entry[0], entry[1].length);
      }
      return JSON.stringify([...reduced]);
    }

    var attemptCount = 0;
    function work() {
      $.get( url+"/work", function( data ) {
        if(data != "") {
          attemptCount = 0;
          $("#data").html(data.rawData.length);
          $("#metaData").html("Job : "+data.job);
          var treatedData;
          if(data.job == "map") {
            treatedData = map(data.rawData);
          }
          else if(data.job == "reduce") {
            treatedData = reduce(data.rawData);
          }
          console.log(treatedData);
          $("#result").html(treatedData);
          $.post(url+"/jobDone", {rawData:treatedData, job:data.job, dataId:data.dataId});
          work();
        }
        else {
          attemptCount++;
          $("#metaData").html("No work to do for now ... Attempt : "+attemptCount);
          setTimeout(function() {work()}, 1000);
        }

    });
    }
  </script>
</html>
